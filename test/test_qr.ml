open Oxqr
open Base

let%expect_test "test_version_2_pattern_modules" =
  let qr = Qr.make ~version:2 in
  Qr.place_pattern_modules qr 2;
  Stdlib.Printf.printf "\n%s\n" (Qr.to_unicode_string qr);
  [%expect
    {|
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████              ██████████████████████              ████████
    ████████  ██████████  ██████████████████████  ██████████  ████████
    ████████  ██      ██  ██████████████████████  ██      ██  ████████
    ████████  ██      ██  ██████████████████████  ██      ██  ████████
    ████████  ██      ██  ██████████████████████  ██      ██  ████████
    ████████  ██████████  ██████████████████████  ██████████  ████████
    ████████              ██  ██  ██  ██  ██  ██              ████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ██████████████████          ████████████████
    ████████████████████████  ██████████████  ██████  ████████████████
    ████████              ██████████████████  ██  ██  ████████████████
    ████████  ██████████  ██████████████████  ██████  ████████████████
    ████████  ██      ██  ██████████████████          ████████████████
    ████████  ██      ██  ████████████████████████████████████████████
    ████████  ██      ██  ████████████████████████████████████████████
    ████████  ██████████  ████████████████████████████████████████████
    ████████              ████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    |}]

let%expect_test "test_version_1_place_data_full" =
  let config = Config.make ~version:1 ~ecl:Config.ECL.L in
  let qr = Qr.make ~version:config.version in
  Qr.place_pattern_modules qr config.version;
  let data = Bytes.init 26 ~f:(fun _ -> Char.of_int_exn 0b11111111) in
  Qr.place_data qr data config.version;
  Stdlib.Printf.printf "\n%s\n" (Qr.to_unicode_string qr);
  [%expect
    {|
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ████████              ████        ██              ████████
    ████████  ██████████  ████        ██  ██████████  ████████
    ████████  ██      ██  ████        ██  ██      ██  ████████
    ████████  ██      ██  ████        ██  ██      ██  ████████
    ████████  ██      ██  ████        ██  ██      ██  ████████
    ████████  ██████████  ████        ██  ██████████  ████████
    ████████              ██  ██  ██  ██              ████████
    ██████████████████████████        ████████████████████████
    ████████████████████  ████        ████████████████████████
    ████████            ██                            ████████
    ████████                                          ████████
    ████████            ██                            ████████
    ████████                                          ████████
    ████████████████████████                          ████████
    ████████              ████                        ████████
    ████████  ██████████  ████                        ████████
    ████████  ██      ██  ████                        ████████
    ████████  ██      ██  ████                        ████████
    ████████  ██      ██  ████                        ████████
    ████████  ██████████  ████                        ████████
    ████████              ████                        ████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    |}]

let%expect_test "test_version_1_place_data_partial" =
  let config = Config.make ~version:1 ~ecl:Config.ECL.L in
  let qr = Qr.make ~version:config.version in
  Qr.place_pattern_modules qr config.version;
  let data = Bytes.init 26 ~f:(fun _ -> Char.of_int_exn 0b10001010) in
  Qr.place_data qr data config.version;
  Stdlib.Printf.printf "\n%s\n" (Qr.to_unicode_string qr);
  [%expect
    {|
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ████████              ██████  ██  ██              ████████
    ████████  ██████████  ██████████  ██  ██████████  ████████
    ████████  ██      ██  ██████  ██████  ██      ██  ████████
    ████████  ██      ██  ██████  ██  ██  ██      ██  ████████
    ████████  ██      ██  ██████  ██  ██  ██      ██  ████████
    ████████  ██████████  ██████████  ██  ██████████  ████████
    ████████              ██  ██  ██  ██              ████████
    ████████████████████████████  ████████████████████████████
    ████████████████████  ██████  ██  ████████████████████████
    ██████████  ██  ██  ████  ██  ██  ██  ██  ██  ██  ████████
    ██████████████  ████  ██  ██████  ██████  ██████  ████████
    ██████████  ██████  ████████  ██████  ██████  ████████████
    ██████████  ██  ██    ██  ██  ██  ██  ██  ██  ██  ████████
    ████████████████████████  ██  ██  ██  ██  ██  ██  ████████
    ████████              ██████████  ██████  ██████  ████████
    ████████  ██████████  ██████  ██████  ██████  ████████████
    ████████  ██      ██  ██████  ██  ██  ██  ██  ██  ████████
    ████████  ██      ██  ██████  ██  ██  ██  ██  ██  ████████
    ████████  ██      ██  ██████████  ██████  ██████  ████████
    ████████  ██████████  ██████  ██████  ██████  ████████████
    ████████              ██████  ██  ██  ██  ██  ██  ████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    |}]

(* Example from https://www.thonky.com/qr-code-tutorial/format-version-information#example-five-bit-format-string *)
let%expect_test "test_format_bits_generation" =
  let format_bits = Qr.compute_format_bits Config.ECL.L 4 in
  for i = 0 to 14 do
    let bit = (format_bits lsr (14 - i)) land 1 in
    Stdlib.Printf.printf "%d" bit
  done;
  Stdlib.Printf.printf "\n";
  [%expect "110011000101111"]

let%expect_test "test_version_2_format_info" =
  let config = Config.make ~version:2 ~ecl:Config.ECL.L in
  let qr = Qr.make ~version:config.version in
  Qr.place_pattern_modules qr config.version;
  Qr.place_format_info qr ~ecl:config.ecl ~mask_pattern:0;
  Stdlib.Printf.printf "\n%s\n" (Qr.to_unicode_string qr);
  [%expect
    {|
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████              ██████████████████████              ████████
    ████████  ██████████  ██████████████████████  ██████████  ████████
    ████████  ██      ██  ██  ██████████████████  ██      ██  ████████
    ████████  ██      ██  ██████████████████████  ██      ██  ████████
    ████████  ██      ██  ██████████████████████  ██      ██  ████████
    ████████  ██████████  ██████████████████████  ██████████  ████████
    ████████              ██  ██  ██  ██  ██  ██              ████████
    ████████████████████████  ████████████████████████████████████████
    ████████      ██          ████████████████    ██████  ████████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ████████████████████  ██████████████████          ████████████████
    ████████████████████████  ██████████████  ██████  ████████████████
    ████████              ██  ██████████████  ██  ██  ████████████████
    ████████  ██████████  ██  ██████████████  ██████  ████████████████
    ████████  ██      ██  ██  ██████████████          ████████████████
    ████████  ██      ██  ████████████████████████████████████████████
    ████████  ██      ██  ██  ████████████████████████████████████████
    ████████  ██████████  ██  ████████████████████████████████████████
    ████████              ██  ████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████████████
    |}]

let%expect_test "test_hello_world" =
  let arena = Encoding.Arena.create None in
  let qr = Encoding.generate_qr arena "HELLO WORLD" Config.ECL.M in
  let qr_string = Qr.to_unicode_string qr in
  Out_channel.output_string Out_channel.stdout (qr_string ^ "\n");
  [%expect
    {|
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ████████              ██████  ██  ██              ████████
    ████████  ██████████  ██      ██████  ██████████  ████████
    ████████  ██      ██  ██████  ██  ██  ██      ██  ████████
    ████████  ██      ██  ██████  ██  ██  ██      ██  ████████
    ████████  ██      ██  ██  ██      ██  ██      ██  ████████
    ████████  ██████████  ████      ████  ██████████  ████████
    ████████              ██  ██  ██  ██              ████████
    ██████████████████████████████████████████████████████████
    ████████  ██  ██  ██  ████  ████  ██████  ████  ██████████
    ██████████        ██████  ████  ████████  ██████  ████████
    ██████████████              ██  ████  ██    ██████████████
    ████████        ██  ██    ████      ██  ██      ██████████
    ██████████  ████        ██  ██  ████      ██  ██  ████████
    ████████████████████████  ██  ██████  ██████  ██  ████████
    ████████              ██████████  ████  ██    ████████████
    ████████  ██████████  ████    ██████    ██  ██████████████
    ████████  ██      ██  ██    ████  ██              ████████
    ████████  ██      ██  ██████    ██  ██  ██████  ██████████
    ████████  ██      ██  ██        ██      ██  ████  ████████
    ████████  ██████████  ████████      ██████  ██    ████████
    ████████              ██    ██  ██      ████████  ████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    ██████████████████████████████████████████████████████████
    |}]
